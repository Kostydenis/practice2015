function log(o){if(logging){var e=new Date;e=e.toLocaleTimeString().replace(/[:]|, |[.]/g,"-"),o=e+": "+o+"\r\n",fs.appendFileSync(logFilePath,o)}}function init(){log("Begin initialization");var o;"ru"==chosenLang&&(o="lang/ru.json"),"en"==chosenLang&&(o="lang/en.json"),log("Chosen language file is "+chosenLang),$.getJSON(o,function(o){log("Begin parsing lang-JSON"),jQuery(document).ready(function(){log("Basic template is initialized"),lang=o,log("Starting initialization of basic template"),initBaseTemplate(),log("starting initialization of extended template"),$("header h1").empty(),$("header h1").append(lang.title),$("#note_mnp").empty(),$("#note_mnp").append(lang.note_mnp+' <a id="learnmore_mnp">'+lang.learnmore+"</a>"),$("#learnmore_mnp").click(function(){gui.Shell.openExternal("http://pravo.gov.ru/proxy/ips/?docbody=&link_id=2&nd=102162254")}),$(".block_number_check").removeClass("preinit"),$("#input_number_check").focus(),$("#input_number_check").attr("placeholder",lang.placeholder_input_number_check),$("#button_number_check").click(function(){log("#button_number_check is pressed");var o=findProvider(strToCode($("#input_number_check").val()).def,strToCode($("#input_number_check").val()).number);openModal(void 0!=o.error?o.error:o.loc+"<br />"+o.prov)}),$("#input_number_check").keypress(function(o){if(13==o.keyCode)if(log("#input_number_check is enter-pressed"),-1!=$(".modal").attr("class").indexOf("preinit")){var e=findProvider(strToCode($("#input_number_check").val()).def,strToCode($("#input_number_check").val()).number);openModal(void 0!=e.error?e.error:e.loc+"<br />"+e.prov)}else closeModal()}),$("input").keypress(function(o){(1==o.ctrlKey&&65==o.keyCode||1==o.metaKey&&65==o.keyCode)&&(this.select(),log("Whole text in input is selected"))}),document.onkeydown=function(o){(1==o.ctrlKey&&82==o.keyCode||1==o.metaKey&&82==o.keyCode)&&(log("Application is reset"),location.reload()),(1==o.ctrlKey&&81==o.keyCode||1==o.metaKey&&81==o.keyCode)&&(log("Closing application"),gui.Window.get().close())},$("#btn_about").empty(),$("#btn_about").append(lang.btn_about),$("#btn_about").click(function(){openModal("Under construction")}),$("#btn_author").empty(),$("#btn_author").append(gui.App.manifest.author),$("#btn_author").click(function(){gui.Shell.openExternal("http://kostydenis.me")}),$(".form_request").removeClass("preinit"),$("#header_form_request").empty(),$("#header_form_request").append(lang.header_form_request),$("#input_locations").attr("data-placeholder",lang.placeholder_input_locations),$("#input_providers").attr("data-placeholder",lang.placeholder_input_providers),$("#input_defs").attr("data-placeholder",lang.placeholder_input_defs),$("#btn_form_request").empty(),$("#btn_form_request").append(lang.btn_form_request),$("#btn_form_request").click(function(){openExportModal()}),$("#btn_clear_form_request").empty(),$("#btn_clear_form_request").append('<span class="glyphicon glyphicon-trash" aria-hidden="true">&nbsp;</span>'+lang.btn_clear_form_request),$("#btn_clear_form_request").click(function(){log("Clear button is pressed"),location.reload()}),$("#btn_update").empty(),$("#btn_update").append(lang.btn_update),$("#btn_update").click(function(){0==navigator.onLine?openModal(lang.youreoffline):updateBase()}),$("#input_number_check").mask("+7 (000) 000-0000"),$("#btn_ru").click(function(){log("Russian language is chosen"),$("#btn_ru").removeClass("not_pressed"),$("#btn_en").addClass("not_pressed"),chosenLang="ru",init()}),$("#btn_en").click(function(){log("English language is chosen"),$("#btn_en").removeClass("not_pressed"),$("#btn_ru").addClass("not_pressed"),chosenLang="en",init()}),$("#export_to_txt").empty(),$("#export_to_txt").append(lang.export_to_txt),$("#export_to_txt").click(function(){log("Exporting to txt"),exportToTxt()}),$("#export_to_excel").empty(),$("#export_to_excel").append(lang.export_to_excel),$("#export_to_excel").click(function(){log("Exporting to excel"),exportToExcel()})})}),log("Extended template is initialized"),base_init()}function getLocations(){var o=[];for(prop in base)o.push(prop);return o}function getProviders(o){var e=[];for(prop in base[o])e.push(prop);return e}function getDefs(o,e){var n=[];for(prop in base[o][e])n.push(prop);return n}function dateDiffInDays(o,e){var n=864e5,t=Date.UTC(o.getFullYear(),o.getMonth(),o.getDate()),r=Date.UTC(e.getFullYear(),e.getMonth(),e.getDate());return Math.floor((r-t)/n)}function updateBase(){showLoading(),"darwin"===os.platform()?exec("open _py/dwnldData.app",function(){$(".last_update").empty();var o=fs.statSync("base/base.json").mtime;$(".last_update").append(lang.base_last_update+o.toLocaleDateString().replace(/[:]|, |[.]/g,"-")),hideLoading(),openModal(lang.successful_update)}):exec("start _py/dwnldData.exe",function(){$(".last_update").empty();var o=fs.statSync("base/base.json").mtime;$(".last_update").append(lang.base_last_update+o.toLocaleDateString().replace(/[:]|, |[.]/g,"-")),hideLoading(),openModal(lang.successful_update)})}function initAutocomplete(){var o=Date.now();locations=getLocations(),providers=[],defs=[],$("#input_locations").empty(),$("#input_providers").empty(),$("#input_defs").empty();var e=1,n=1;for(loc in locations){$("#input_locations").append("<option>"+locations[loc]+"</option>"),$("#input_providers").append('<optgroup label="'+locations[loc]+'" id="provider_optgroup'+e+'">');var t=getProviders(locations[loc]);for(prov in t){providers.push(t[prov]),$("#input_providers #provider_optgroup"+e).append("<option>"+t[prov]+"</option>");var r=getDefs(locations[loc],t[prov]);$("#input_defs").append('<optgroup label="'+t[prov].replace(/"([^"]+)"/g,"«$1»")+'" id="def_optgroup'+n+'">');for(def in r)defs.push(r[def]),$("#input_defs #def_optgroup"+n).append("<option>"+r[def]+"</option>");n++}e++}var i=Date.now();console.log("init: "+(i-o)),$("#input_locations").trigger("chosen:updated"),$("#input_providers").trigger("chosen:updated"),$("#input_defs").trigger("chosen:updated")}function buildChoose(){var o=Date.now();if(chosenLocations=[],chosenProviders=[],chosenDefs=[],chosenLocations=null!=$("#input_locations").val()?$("#input_locations").val():getLocations(),null!=$("#input_providers").val())chosenProviders=$("#input_providers").val();else for(loc in chosenLocations){var e=getProviders(chosenLocations[loc]);for(prov in e)chosenProviders.push(e[prov])}if(null!=$("#input_defs").val())chosenDefs=$("#input_defs").val();else if(null==$("#input_providers").val())for(loc in chosenLocations){var e=getProviders(chosenLocations[loc]);for(prov in e){var n=getDefs(chosenLocations[loc],e[prov]);for(def in n)chosenDefs.push(n[def])}}else for(loc in chosenLocations)for(prov in chosenProviders)if(-1!=$.inArray(chosenProviders[prov],getProviders(chosenLocations[loc]))){var n=getDefs(chosenLocations[loc],chosenProviders[prov]);for(def in n)chosenDefs.push(n[def])}var t=Date.now();console.log("buildChoose() push: "+(t-o))}function getInterval(o,e,n){var t=[];for(prop in base[o][e][n])t.push(prop);return t}function isInInterval(o,e,n){return e>=o&&n>=e?!0:!1}function strToCode(o){var e={};return e.def=o.substring(4,7),e.number=o.substring(9).replace("-",""),e}function findEqualDigits(o,e){for(var n=0,t=0;t<o.length;t++){if(o[t]!==e[t])return n;n++}return n}function findEqualDigitsInArray(o){for(var e=0,n=0;n<o[0].length;n++){if(o[0][n]!==o[1][n])return e;e++}return e}function findZeroQty(o){for(var e=0,n=o;"0"===n[n.length-1];)n=n.slice(0,-1),e++;return e}function findNineQty(o){for(var e=0,n=o;"9"===n[n.length-1];)n=n.slice(0,-1),e++;return e}function intervalToTemplate(o){var e,n=[],t=findNineQty(o[1]),r=findZeroQty(o[0]);e=r>t?t:r,o[0]=o[0].slice(0,-1*e),o[1]=o[1].slice(0,-1*e),e=findEqualDigitsInArray(o);var i=o[0].slice(0,e);o[0]=o[0].slice(e),o[1]=o[1].slice(e);var a=o[1]-o[0];if(0==a)n.push(i+"%");else for(var s=parseInt(o[0]);s<=parseInt(o[0])+a;s++)n.push(i+s+"%");return n}function exportToTXT(){log("Starting export to txt");var o=new Date;if(o=o.toLocaleString().replace(/[:]|, |[.]/g,"-"),fs.mkdirSync(saveTo+o),log("Folder "+o+" is created"),null==$("#input_providers").val())if(null==$("#input_defs").val())for(loc in chosenLocations){fs.mkdirSync(saveTo+o+"/"+chosenLocations[loc]);var e=getProviders(chosenLocations[loc]);for(prov in e){var n=fs.openSync(saveTo+o+"/"+chosenLocations[loc]+"/"+e[prov].replace(/"([^"]+)"/g,"«$1»")+".txt","w"),t=getDefs(chosenLocations[loc],e[prov]);for(def in t){var r=getInterval(chosenLocations[loc],e[prov],t[def]);for(intvl in r){var i=intervalToTemplate(r[intvl].split("-"));for(tmpl in i)fs.writeSync(n,t[def]+i[tmpl]+"\r\n")}}fs.close(n)}}else for(loc in chosenLocations){fs.mkdirSync(saveTo+o+"/"+chosenLocations[loc]),log("File "+chosenLocations[loc]+" is created");var e=getProviders(chosenLocations[loc]);for(prov in e){var n=fs.openSync(saveTo+o+"/"+chosenLocations[loc]+"/"+e[prov].replace(/"([^"]+)"/g,"«$1»")+".txt","w");for(def in chosenDefs)if(-1!=$.inArray(chosenDefs[def],getDefs(chosenLocations[loc],e[prov]))){var r=getInterval(chosenLocations[loc],e[prov],chosenDefs[def]);for(intvl in r){var i=intervalToTemplate(r[intvl].split("-"));for(tmpl in i)fs.writeSync(n,chosenDefs[def]+i[tmpl]+"\r\n")}}fs.close(n)}}else if(null==$("#input_defs").val())for(loc in chosenLocations){fs.mkdirSync(saveTo+o+"/"+chosenLocations[loc]),log("File "+chosenLocations[loc]+" is created");for(prov in chosenProviders){var n=fs.openSync(saveTo+o+"/"+chosenLocations[loc]+"/"+chosenProviders[prov].replace(/"([^"]+)"/g,"«$1»")+".txt","w");if(-1!=$.inArray(chosenProviders[prov],getProviders(chosenLocations[loc]))){var t=getDefs(chosenLocations[loc],chosenProviders[prov]);for(def in t){var r=getInterval(chosenLocations[loc],chosenProviders[prov],t[def]);for(intvl in r){var i=intervalToTemplate(r[intvl].split("-"));for(tmpl in i)fs.writeSync(n,t[def]+i[tmpl]+"\r\n")}}}fs.close(n)}}else for(loc in chosenLocations){fs.mkdirSync(saveTo+o+"/"+chosenLocations[loc]),log("File "+chosenLocations[loc]+" is created");for(prov in chosenProviders){var n=fs.openSync(saveTo+o+"/"+chosenLocations[loc]+"/"+chosenProviders[prov].replace(/"([^"]+)"/g,"«$1»")+".txt","w");if(-1!=$.inArray(chosenProviders[prov],getProviders(chosenLocations[loc])))for(def in chosenDefs)if(-1!=$.inArray(chosenDefs[def],getDefs(chosenLocations[loc],chosenProviders[prov]))){var r=getInterval(chosenLocations[loc],chosenProviders[prov],chosenDefs[def]);for(intvl in r){var i=intervalToTemplate(r[intvl].split("-"));for(tmpl in i)fs.writeSync(n,chosenDefs[def]+i[tmpl]+"\r\n")}}fs.close(n)}}}function exportToExcel(){showLoading(),log("Starting export to excel");var o=new Date;o=o.toLocaleString().replace(/[:]|, |[.]/g,"-"),fs.mkdirSync(saveTo+o);var e=excelbuilder.createWorkbook(saveTo+o+"/","defs.xlsx");if(log("Excel file is created"),null==$("#input_providers").val())if(null==$("#input_defs").val())for(loc in chosenLocations){var n=e.createSheet(chosenLocations[loc],1,3e3);log("Sheet "+chosenLocations[loc]+" is created");var t=1,r=getProviders(chosenLocations[loc]);for(prov in r){var i=getDefs(chosenLocations[loc],r[prov]);for(def in i){var a=getInterval(chosenLocations[loc],r[prov],i[def]);for(intvl in a){var s=intervalToTemplate(a[intvl].split("-"));for(tmpl in s)n.set(1,t++,i[def]+s[tmpl])}}}}else for(loc in chosenLocations){var n=e.createSheet(chosenLocations[loc],1,3e3);log("Sheet "+chosenLocations[loc]+" is created");var t=1,r=getProviders(chosenLocations[loc]);for(prov in r)for(def in chosenDefs)if(-1!=$.inArray(chosenDefs[def],getDefs(chosenLocations[loc],r[prov]))){var a=getInterval(chosenLocations[loc],r[prov],chosenDefs[def]);for(intvl in a){var s=intervalToTemplate(a[intvl].split("-"));for(tmpl in s)n.set(1,t++,chosenDefs[def]+s[tmpl])}}}else if(null==$("#input_defs").val())for(loc in chosenLocations){var n=e.createSheet(chosenLocations[loc],1,3e3);log("Sheet "+chosenLocations[loc]+" is created");var t=1;for(prov in chosenProviders)if(-1!=$.inArray(chosenProviders[prov],getProviders(chosenLocations[loc]))){var i=getDefs(chosenLocations[loc],chosenProviders[prov]);for(def in i){var a=getInterval(chosenLocations[loc],chosenProviders[prov],i[def]);for(intvl in a){var s=intervalToTemplate(a[intvl].split("-"));for(tmpl in s)n.set(1,t++,i[def]+s[tmpl])}}}}else for(loc in chosenLocations){var n=e.createSheet(chosenLocations[loc],1,3e3);log("Sheet "+chosenLocations[loc]+" is created");var t=1;for(prov in chosenProviders)if(-1!=$.inArray(chosenProviders[prov],getProviders(chosenLocations[loc])))for(def in chosenDefs)if(-1!=$.inArray(chosenDefs[def],getDefs(chosenLocations[loc],chosenProviders[prov]))){var a=getInterval(chosenLocations[loc],chosenProviders[prov],chosenDefs[def]);for(intvl in a){var s=intervalToTemplate(a[intvl].split("-"));for(tmpl in s)n.set(1,t++,chosenDefs[def]+s[tmpl])}}}e.save(function(){hideLoadingWOWrapper(),alert(lang.successful_export)})}function exportToScreen(){if(null==$("#input_providers").val())if(null==$("#input_defs").val())for(loc in chosenLocations){$("#modal-content").append("<h3>"+chosenLocations[loc]+"</h3>");var o=getProviders(chosenLocations[loc]);for(prov in o){$("#modal-content").append("<h4>"+o[prov]+"</h4>");var e=getDefs(chosenLocations[loc],o[prov]);for(def in e){var n=getInterval(chosenLocations[loc],o[prov],e[def]);for(intvl in n){var t=intervalToTemplate(n[intvl].split("-"));for(tmpl in t)$("#modal-content").append("<p>"+e[def]+t[tmpl]+"</p>")}}}}else for(loc in chosenLocations){$("#modal-content").append("<h3>"+chosenLocations[loc]+"</h3>");var o=getProviders(chosenLocations[loc]);for(prov in o){$("#modal-content").append("<h4>"+o[prov]+"</h4>");for(def in chosenDefs)if(-1!=$.inArray(chosenDefs[def],getDefs(chosenLocations[loc],o[prov]))){var n=getInterval(chosenLocations[loc],o[prov],chosenDefs[def]);for(intvl in n){var t=intervalToTemplate(n[intvl].split("-"));for(tmpl in t)$("#modal-content").append("<p>"+chosenDefs[def]+t[tmpl]+"</p>")}}}}else if(null==$("#input_defs").val())for(loc in chosenLocations){$("#modal-content").append("<h3>"+chosenLocations[loc]+"</h3>");for(prov in chosenProviders)if($("#modal-content").append("<h4>"+chosenProviders[prov]+"</h4>"),-1!=$.inArray(chosenProviders[prov],getProviders(chosenLocations[loc]))){var e=getDefs(chosenLocations[loc],chosenProviders[prov]);for(def in e){var n=getInterval(chosenLocations[loc],chosenProviders[prov],e[def]);for(intvl in n){var t=intervalToTemplate(n[intvl].split("-"));for(tmpl in t)$("#modal-content").append("<p>"+e[def]+t[tmpl]+"</p>")}}}}else for(loc in chosenLocations){$("#modal-content").append("<h3>"+chosenLocations[loc]+"</h3>");for(prov in chosenProviders)if($("#modal-content").append("<h4>"+chosenProviders[prov]+"</h4>"),-1!=$.inArray(chosenProviders[prov],getProviders(chosenLocations[loc])))for(def in chosenDefs)if(-1!=$.inArray(chosenDefs[def],getDefs(chosenLocations[loc],chosenProviders[prov]))){var n=getInterval(chosenLocations[loc],chosenProviders[prov],chosenDefs[def]);for(intvl in n){var t=intervalToTemplate(n[intvl].split("-"));for(tmpl in t)$("#modal-content").append("<p>"+chosenDefs[def]+t[tmpl]+"</p>")}}}}function showLoading(){$(".modal_wrapper").removeClass("hide"),$("#loading_anim").removeClass("hide")}function hideLoading(){$(".modal_wrapper").addClass("hide"),$("#loading_anim").addClass("hide")}function hideLoadingWOWrapper(){$("#loading_anim").addClass("hide")}function setError(){$("#error").removeClass("hide"),$("#error").addClass("show"),$("#error").append("<p>"+lang.needupdate+'<a id="gonnaupdate">'+lang.gonnaupdate+"</a></p>"),$("#error").append(),$("#gonnaupdate").click(updateBase),$("#error").append('<span id="unSetError" class="glyphicon glyphicon-remove" aria-hidden="true"></span>'),$("#unSetError").click(unSetError)}function unSetError(){$("#error").removeClass("show"),$("#error").addClass("hide"),setTimeout(function(){$("#error").empty()},200)}function chooseFile(){var o=$("#chooseDirectory");o.unbind("change"),o.change(function(){saveTo=$(this).val()+"/",$("#saveTo").text(saveTo)}),o.trigger("click")}function openExportModal(){log("Export modal is opened"),$(".nano").nanoScroller(),$(".modal").addClass("nano"),$(".modal").append('<div class="nano-content" id="modal-content"></div>'),$("#modal-content").append('<div class="change_path_block"></div>'),$(".change_path_block").append('<input style="display: none" id="chooseDirectory" type="file" nwdirectory nwworkingdir="'+window.location.pathname+'" />'),$(".change_path_block").append('<span id="currPath">'+lang.currPath+"</span>"),$(".change_path_block").append('<span id="saveTo">'+saveTo+"</span>"),$(".change_path_block").append('<button id="change_path_button">'+lang.change_path+"</button>"),$("#change_path_button").click(chooseFile),$("#modal-content").append('<button class="export_btn" id="export_to_txt">'+lang.export_to_txt+"</button>"),$("#export_to_txt").click(function(){exportToTXT(),alert(lang.successful_export)}),$("#modal-content").append('<button class="export_btn" id="export_to_excel">'+lang.export_to_excel+"</button>"),$("#export_to_excel").click(function(){exportToExcel()}),$("#modal-content").append('<button class="export_btn" id="btn_close_export_modal">OK</button>'),$("#btn_close_export_modal").click(function(){closeExportModal()}),$("#modal_wrapper").removeClass("hide"),$(".modal").removeClass("preinit"),buildChoose(),exportToScreen(),$("#modal-content").append('<button class="export_btn" id="export_to_txt_2">'+lang.export_to_txt+"</button>"),$("#export_to_txt_2").click(function(){exportToTXT(),alert(lang.successful_export)}),$("#modal-content").append('<button class="export_btn" id="export_to_excel_2">'+lang.export_to_excel+"</button>"),$("#export_to_excel_2").click(function(){exportToExcel()}),$("#modal-content").append('<button class="export_btn" id="btn_close_export_modal_2">OK</button>'),$("#btn_close_export_modal_2").click(function(){closeExportModal()})}function closeExportModal(){log("Export modal is closed"),$("modal").removeClass("nano"),$("#modal_wrapper").addClass("hide"),$(".modal").addClass("preinit"),$(".modal").empty(),location.reload()}function openModal(o){log("Opened common modal with message: "+o),$("#modal_wrapper").removeClass("hide"),$(".modal").removeClass("preinit"),$(".modal").append("<p>"+o+"</p>"),$(".modal").append('<button id="btn_modal_ok">OK</button>'),$("#btn_modal_ok").click(function(){closeModal()})}function closeModal(){$("#modal_wrapper").addClass("hide"),$(".modal").addClass("preinit"),$(".modal").empty()}function findProvider(o,e){log("Starting find provider");var n,t,r={};for(loc in locations){n=getProviders(locations[loc]);for(prov in n){t=getDefs(locations[loc],n[prov]);for(def in t)if(t[def]==o){var i=getInterval(locations[loc],n[prov],t[def]);for(intvl in i){var a=i[intvl].toString().split("-");if(isInInterval(a[0],e,a[1]))return r.loc=locations[loc],r.prov=n[prov],base_init(),r}}}}return r.error=lang.error_number_not_found,base_init(),r}function initBaseTemplate(){var o="";o="darwin"===os.platform()?'<p class="input_tip">'+lang.input_tip_mac+"</p>":'<p class="input_tip">'+lang.input_tip_win+"</p>";var e;e="ru"===chosenLang?'<div id="btn_en" class="switch_lang_btn not_pressed">en</div><div id="btn_ru" class="switch_lang_btn">ru</div>':'<div id="btn_en" class="switch_lang_btn">en</div><div id="btn_ru" class="switch_lang_btn not_pressed">ru</div>',$("body").empty(),$("body").append('<div id="modal_wrapper" class="modal_wrapper hide"></div><div id="modal" class="modal preinit"></div><img id="loading_anim" class="hide" src="_pics/loading.gif"><header><img src="_pics/sled_hero.png"><h1></h1></header><div class="content"><div id="error" class="hide"></div><div class="block_number_check preinit"><input type="text" id="input_number_check" /><button id="button_number_check"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></button><p class="NB" id="note_mnp"></p></div><div class="form_request preinit"><h2 id="header_form_request"></h2>'+o+'<select id="input_locations" class="chosen-select" multiple ></select><select id="input_providers" class="chosen-select" multiple ></select><select id="input_defs" class="chosen-select" multiple ></select><button id="btn_form_request"></button><button id="btn_clear_form_request"></button></div><div class="update"><button id="btn_update" ></button><span class="last_update">2015-08-3</span></div><div class="switch_lang">'+e+'</div></div><footer><p><a id="btn_author"></a></p><p><a id="btn_about"></a></p><p id="lbl_year">2015</p></footer>')}var os=require("os"),gui=require("nw.gui"),fs=require("fs"),exec=require("child_process").exec,spawn=require("child_process").spawn,excelbuilder=require("msexcel-builder"),logging=!1,lang,chosenLang="ru",base,locations=[],providers=[],defs=[],chosenLocations=[],chosenProviders=[],chosenDefs=[],saveTo;saveTo="darwin"===os.platform()?window.location.pathname.slice(0,-10):window.location.pathname.slice(1,-10);var logFileDate=new Date;logFileDate=logFileDate.toLocaleString().replace(/[:]|, |[.]/g,"-");var logFilePath="logs/"+logFileDate+".txt";log("Application is launched"),log("OS Platform: "+os.platform()),log("OS Type: "+os.type()),log("OS Release: "+os.release()),log("OS Arch: "+os.arch()),log("OS Hostname: "+os.hostname());var base_init=function(){log("Staring initialization of base"),$.getJSON("base/base.json",function(o){$(".last_update").empty();var e=fs.statSync("base/base.json").mtime;$(".last_update").append(lang.base_last_update+e.toLocaleDateString().replace(/[:]|, |[.]/g,"-")),dateDiffInDays(e,new Date)>30&&setError(),base=o,log("base is opened"),locations=getLocations(),log("locations is formed"),initAutocomplete(),$("#input_locations").chosen().change(function(){if($("#input_providers").empty(),$("#input_defs").empty(),locations=[],providers=[],defs=[],null!=$("#input_locations").val()){locations=$("#input_locations").val();var o=1,e=1;for(loc in locations){$("#input_providers").append('<optgroup label="'+locations[loc]+'" id="provider_optgroup'+o+'">');var n=getProviders(locations[loc]);for(prov in n){providers.push(n[prov]),$("#input_providers #provider_optgroup"+o).append("<option>"+n[prov]+"</option>");var t=getDefs(locations[loc],n[prov]);$("#input_defs").append('<optgroup label="'+n[prov].replace(/"([^"]+)"/g,"«$1»")+'" id="def_optgroup'+e+'">');for(def in t)defs.push(t[def]),$("#input_defs #def_optgroup"+e).append("<option>"+t[def]+"</option>");e++}o++}}else initAutocomplete();$("#input_providers").trigger("chosen:updated"),$("#input_defs").trigger("chosen:updated")}),$("#input_providers").chosen().change(function(){if($("#input_defs").empty(),providers=[],defs=[],null!=$("#input_providers").val())if(null==$("#input_locations").val()){$("#input_locations").empty(),$("#input_locations").attr("disabled",!0),locations=[];var o=1;providers=$("#input_providers").val();var e=getLocations();for(loc in e)for(prov in providers)if(-1!=$.inArray(providers[prov],Object.keys(base[e[loc]]))){var n=getDefs(e[loc],providers[prov]);$("#input_defs").append('<optgroup label="'+e[loc]+'" id="def_optgroup'+o+'">');for(def in n)defs.push(n[def]),$("#input_defs #def_optgroup"+o).append("<option>"+n[def]+"</option>");o++}}else{var o=1;providers=$("#input_providers").val();for(loc in locations)for(prov in providers)if(-1!=$.inArray(providers[prov],Object.keys(base[locations[loc]]))){var n=getDefs(locations[loc],providers[prov]);$("#input_defs").append('<optgroup label="'+providers[prov].replace(/"([^"]+)"/g,"«$1»")+'" id="def_optgroup'+o+'">');for(def in n)defs.push(n[def]),$("#input_defs #def_optgroup"+o).append("<option>"+n[def]+"</option>");o++}}else if($("#input_locations").attr("disabled",!1),null==$("#input_locations").val())initAutocomplete();else{locations=getLocations();var o=1;for(loc in locations){var t=getProviders(locations[loc]);for(prov in t){providers.push(t[prov]);var n=getDefs(locations[loc],t[prov]);$("#input_defs").append('<optgroup label="'+t[prov].replace(/"([^"]+)"/g,"«$1»")+'" id="def_optgroup'+o+'">');for(def in n)defs.push(n[def]),$("#input_defs #def_optgroup"+o).append("<option>"+n[def]+"</option>");o++}}}var r=Date.now();$("#input_locations").trigger("chosen:updated"),$("#input_defs").trigger("chosen:updated");var i=Date.now();console.log("trigger: "+(i-r))}),$("#input_defs").chosen().change(function(){null!=$("#input_defs").val()?null==$("#input_locations").val()&&null==$("#input_providers").val()&&($("#input_locations").attr("disabled",!0),$("#input_providers").attr("disabled",!0)):null==$("#input_locations").val()&&null==$("#input_providers").val()&&($("#input_locations").attr("disabled",!1),$("#input_providers").attr("disabled",!1),initAutocomplete()),$("#input_locations").trigger("chosen:updated"),$("#input_providers").trigger("chosen:updated")}),$("#input_locations").chosen(),$("#input_providers").chosen(),$("#input_defs").chosen()})};init("ru");